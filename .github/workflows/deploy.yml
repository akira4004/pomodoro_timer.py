name: Deploy to Yandex Cloud

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Test the application
      run: |
        python -m pytest tests/ -v
    
    - name: Deploy to Yandex Cloud
      env:
        YC_OAUTH_TOKEN: ${{ secrets.YC_OAUTH_TOKEN }}
        YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
      run: |
        # Установка Yandex Cloud CLI
        curl https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        
        # Инициализация
        /tmp/yandex-cloud/bin/yc init --token $YC_OAUTH_TOKEN --folder-id $YC_FOLDER_ID
        
        # Деплой функции
        /tmp/yandex-cloud/bin/yc serverless function create --name=workout-bot
        /tmp/yandex-cloud/bin/yc serverless function version create \
          --function-name=workout-bot \
          --runtime python39 \
          --entrypoint index.handler \
          --memory 128m \
          --execution-timeout 10s \
          --source-path .
